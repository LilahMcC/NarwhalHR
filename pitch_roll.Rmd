---
title: "pitch_roll"
author: "Lilah McCormick"
date: '2022-07-07'
output: 
  html_document:
    toc: yes
    toc_float: yes 
    theme: default 
    highlights: monotone
---
### Load libraries: 
```{r load libraries, echo = FALSE}
library(tidyverse)
library(lubridate)
```

### Data manipulation: 
#### Overarching Task: Write two R functions that take acceleration as the input and return pitch and roll


##### Step 1: read files into r and tidy dataframe:   
Write a function to read files and put into a df   
```{r create_acc_df}
# create_acc_df creates a dataframe with columns acceleration (in millig?) and DateTime to minimize repetitive coding. 

#Parameters: 
# file = name of text file. eg: "name_of_file.txt"
# nrow = number of rows to read. eg: 10000

col_name_vector <- c("acceleration", "%", "DateTime")

create_acc_df <- function(file, nrow){
  df_name <- read_tsv(file, col_names = col_name_vector, n_max = nrow) %>% 
  mutate(DateTime = mdy_hms(`DateTime`), .keep = "unused") %>%   #fix datetime
  mutate(acceleration = acceleration/1000, .keep = "unused") %>%  # makes units milli-g
  mutate("%" = NULL) #removes "%" column 

}
  
```
Apply function to each txt file:  
```{r read_files}
acc_i <- create_acc_df("HDI0_Asgeir.txt", nrow = 2)
acc_j <- create_acc_df("HDJ0_Asgeir.txt", nrow = 2)
acc_k <- create_acc_df("HDK0_Asgeir.txt", nrow = 2)
```
Combine three data frames into one:  
```{r combine_acceleration}
###This is returning a df with character type for j and k acceleration which doesn't work when i do pivot_longer() in the next step 
acc_all <- acc_i %>% 
  mutate("acceleration_j" = acc_j[1], "acceleration_k" = acc_k[1]) %>% 
  rename(acceleration_i = acceleration) %>%  #can't figure out how to rename other columns 
  relocate("DateTime") #move DateTime column all the way left 
```

pivot_longer() on the combined dataframe 
```{r pivot_longer_df}
acc_all %>% 
  pivot_longer(!DateTime, 
               names_to = "axis", 
               values_to = "acceleration")
```


##### Step 2: Connect I,J,K to Surge, Sway, Heave
```{r plot_acc_func}
# plot_dive_func plots an acceleration vs. time graph given a set of parameters to minimize repetition of code when plotting acceleration  profiles at multiple timescales.

# Parameters: 
# dataframe - must be a dataframe. 
# start_time/end_time - must be character strings in 'YYYY-MM-DD hh:mm:ss' format.
# title - must be a character string in "Graph Title" format. 

plot_acc <- function(dataframe, start_time, end_time, title) {
  one_dive <- filter(dataframe, DateTime >= start_time, DateTime <= end_time)
  ggplot(one_dive, aes(x = DateTime, y = Acceleration)) +
    geom_line() +
    labs(title = title,
         x = "Time",
         y = "acceleration") + #changes labels on axes and title 
    theme_bw()  #white background
}
```

```{r plot_dive_profile_func}
# plot_dive_func plots a dive profile given a set of parameters to minimize repetition of code when plotting dive profiles at multiple timescales.

# Parameters: 
# dataframe - must be a dataframe. 
# start_time/end_time - must be character strings in 'YYYY-MM-DD hh:mm:ss' format.
# title - must be a character string in "Graph Title" format. 

plot_dive <- function(dataframe, start_time, end_time, title) {
  one_dive <- filter(dataframe, DateTime >= start_time, DateTime <= end_time)
  dive_plot <- ggplot(one_dive, aes(x = DateTime, y = Depth)) +
    geom_line() +
    scale_y_reverse() + #makes depth right orientation 
    labs(title = title,
        x = "Time",
        y = "Depth (m)") + #changes labels on axes and title 
    theme_bw()  #white background
  dive_plot
}
```


```{r plot accleration next to dive profile}
start_dive <- ymd_hms('2018-08-24 08:26:01')
end_dive <- ymd_hms('2018-08-24 08:57:00')

#Plot acceleration
plot_acc(acc_i, start_dive, end_dive, "accleration i")
plot_acc(acc_j, start_dive, end_dive, "accleration j")
plot_acc(acc_k, start_dive, end_dive, "accleration k")

#Plot depth 
depth_data <- read_tsv("Depth_Asgeir.txt") %>% #read file 
  mutate(DateTime = mdy_hms(`Date time`), .keep = "unused") #fix datetime
plot_dive(depth_data, start_dive, end_dive, "Depth Profile")

```

######  Based on the comparison of depth profile to the acceleration plots, I have made the following guesses about the alignment of the i,j,k axes and the surge, heave, and sway directions of the animal:    

**I: Surge** - the projection of g onto the cranio-caudal axis should be negative during descent, and positive during ascent (depending on how you define your axes). It should be roughly 0 when the animal is at 0 degrees of pitch (at the surface). Based on these parameters, the acceleration i plot aligns most closely with the surge (X) axis.   
**J: Sway** - the projection of g onto the lateral axis likely does not vary consistently with a change in pitch of the animal. The j acceleration plot does not show any correlation with depth, and therefore, is measuring acceleration on the sway (Y) axis.   
**K: Heave** - the projection of g onto the dorso-ventral axis will be most strongly negative when the animal is at a 0 degree pitch angle (it's likely behavior at the surface), and will become less negative when the animal is angled up or down. It should only be positive if the animal is upside-down. Because the k acceleration values are consistently strongly negative during the surface interval, and slightly less negative during ascent, k acceleration is likely measuring acceleration in the heave (Z) axis. It's very interesting to note that on the descent, the values are positive, possibly indicating the presence of the falling-leaf dive behavior documented in elephant seals. 