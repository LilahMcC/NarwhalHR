---
title: "narwhal_BCG"
author: "Lilah McCormick"
date: '2022-07-25'
output: html_document
---
```{r load}
source("util.R")
library(tidyverse)
library(lubridate)
library(cetaceanbcg)
```

```{r motionless}
ml_best_asgeir <- 
  read_tsv("narwhal_motionless.tsv") %>% 
  filter(meets_criteria == "Y", narwhal_id == "asgeir") %>% 
  mutate(region_id = row_number()) %>% 
  select(-c("duration", narwhal_id, dive_phase, notes, meets_criteria))
```


```{r narwhal-beats}
win_s <- 1
acc_fs <- 100

should_retain <- function(dt, motionless, buffer_s) { #dt is DateTime col of acc data
  retain <- logical(length(dt)) #retain is a column of T/F values 
  motionless <- filter(motionless, time_end < max(dt), time_start > min(dt))
  i_start <- as.numeric(motionless$time_start - buffer_s - dt[1],
                        unit = "secs") * acc_fs + 1
  i_end <- as.numeric(motionless$time_end + buffer_s - dt[1],
                      unit = "secs") * acc_fs + 1
  retain_idx <- map2(i_start, i_end, ~ .x:.y) %>% 
    unlist() %>% 
    pmin(length(dt)) %>% 
    pmax(1)
  retain[retain_idx] <- TRUE
  retain
}

narwhal_100hz <- read_acc("HDI0_Asgeir.txt", 
                          "HDJ0_Asgeir.txt", 
                          "HDK0_Asgeir.txt", 
                          nrow = 4.5e6) %>% 
  slice(3e6:4.5e6) %>% 
  mutate(retain = should_retain(DateTime, ml_best_asgeir, 2)) %>% 
  filter(retain) %>% 
  mutate(
    timestep = as.numeric(DateTime - lag(DateTime, default = DateTime[1] - acc_fs * 2), 
                          unit = "secs"),
    contiguous = abs(timestep - 1 / acc_fs) < 1e-4,
    contiguous_id = cumsum(!contiguous)
  ) %>% 
  group_by(contiguous_id) %>% 
  mutate(
    across(acc_x:acc_z, 
           filter_acc, fs = acc_fs, upper = 25.0, #applies bandwidth filter
           .names = "{.col}_filt"),
    jerk = jerk(cbind(acc_x_filt, acc_y_filt, acc_z_filt), #differencing
                fs = acc_fs, p = 4, n = win_s * acc_fs + 1),
    jerk_se = shannon_entropy(jerk), #shannon entropy
    jerk_smooth = tma(jerk_se, win_s * acc_fs), #triangular moving average - why do I have lots of NA values?
    # Annotate regions
    rid_left = approx(ml_best_asgeir$time_start, 
                      ml_best_asgeir$region_id, 
                      DateTime, 
                      "constant")$y,
    rid_right = approx(ml_best_asgeir$time_end, 
                       ml_best_asgeir$region_id, 
                       DateTime, 
                       "constant", 
                       yleft = 0)$y + 1,
    rid = ifelse(rid_left == rid_right, rid_left, NA),
    # Zero-out signal in non-valid regions (i.e. remove movement artifacts)
    jerk_smooth = ifelse(is.na(rid), 0, jerk_smooth)
  ) %>% 
  ungroup()
    #bcg_beat = find_beats(jerk_smooth, acc_fs, win_s) #getting an error here 
  # ) %>% 
  # # Calculate heart rate within each region
  # group_by(region_id) %>% 
  # mutate(bcg_bpm = bpm(bcg_beat, dt)) %>% 
  # ungroup() %>% 
  # select(-c(rid_left, rid_right))
```